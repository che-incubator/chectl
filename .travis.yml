jobs:
  include:
  - os: osx
arch:
- amd64
- s390x
language: node_js
node_js: '10'
before_deploy:
- |
  if ! [ "$BEFORE_DEPLOY_DONE" ]; then
    export BEFORE_DEPLOY_DONE=1
    brew update
    brew install p7zip
    git config --local user.name "Mario Loriedo"
    git config --local user.email "mario.loriedo@gmail.com"
    export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')}
    export CHECTL_VERSION="UNKNOWN"
    export GITHUB_RELEASE_NAME=$TRAVIS_TAG
    if [ "$TRAVIS_BRANCH" = master ]; then
      echo "Branch is master branch..."
      CURRENT_DAY=$(date +'%Y%m%d')
      SHORT_SHA1=$(git rev-parse --short HEAD)
      export CHECTL_VERSION=0.0.$CURRENT_DAY-next
      export GITHUB_RELEASE_NAME=0.0.$CURRENT_DAY-next.$SHORT_SHA1
    fi;
    if [ "$TRAVIS_BRANCH" = release ]; then
      echo "Branch is release branch..."
      export CHECTL_VERSION=$(cat VERSION)
      export TRAVIS_TAG=${TRAVIS_TAG:-$CHECTL_VERSION}
      export GITHUB_RELEASE_NAME=$CHECTL_VERSION
    fi;
    sed -i sed "s#version\":\ \"\(.*\)\",#version\":\ \"$CHECTL_VERSION\",#g" package.json
    git tag $TRAVIS_TAG
    npx oclif-dev pack
    git clone https://github.com/che-incubator/chectl -b gh-pages --single-branch gh-pages
    rm -rf gh-pages/.git
    echo $(date +%s) > gh-pages/update
    env
  fi
deploy:
  provider: releases
  api_key:
    secure: J5YFaxiVgP6mWTWsdveGZOe1wdAvtlmDStCgg5O8ZZp3TpdW4osmxJOR1cdRPSYNjhJQblLbe7q6BONE0SJ4RCb2fjD41Dk5xa2p8pvrWhrGaXwsqPO/HPwSjP2qcROEiCP+AfaMleDRXwtU0DtOyEB735D77BgIIgmlqN8LyQ7Ixz1RDTisdywBntbsriDtpVvh3HNrkECRHFA39ET8LipQotjdBvlxMJUiVfAnXU4pEXJCckVBvQBeX2PabZSWMt+IgeQO3N8Ki8+YMrIrez5VkWb68fMujlGI0l79vIyPkmYao2usV+QlDz95vIteOXfNtZwljmBalovDKb5wtt0dIPYR1yACEoyRhUnBoNy2yREcZW2oFFycWuLqjUFGbS039mmFbbtPTVDsSC8QzEC0l0omU/hzeAgh7QhY4h+u70g/rHa9T4CHm7vvuY9c8q4Wjg14c64Ais7CPkPcKS6XlevAGXkp6Q20x1Y0VbJskApPWuFJ2rU/KuuRgRMxLubSHBU4lb3zdRGzpw8bGc3bCxDLUuKzDON8TtGmXBHtvYsuSMwUl89Mc08wnJpg9uC6csjtKfA7i3DeukT8TYiucL70PQoVJsRKEknrBBl85WIoeoHma+der9dbUrcYdsP/HYt3nQdgmfohHKy0/qfdk8oL/S3TMrTx5Y6HBeM=
  file: ''
  on:
    repo: flacatus/chectl
