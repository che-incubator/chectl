jobs:
  include:
   - os: osx
   - os: linux
     arch:
      - amd64
      - s390x
language: node_js
node_js: '10'
before_deploy:
- |
  if ! [ "$BEFORE_DEPLOY_DONE" ]; then
    export BEFORE_DEPLOY_DONE=1
    brew update
    brew install p7zip
    git config --local user.name "Mario Loriedo"
    git config --local user.email "mario.loriedo@gmail.com"
    export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')}
    export CHECTL_VERSION="UNKNOWN"
    export GITHUB_RELEASE_NAME=$TRAVIS_TAG
    if [ "$TRAVIS_BRANCH" = master ]; then
      echo "Branch is master branch..."
      CURRENT_DAY=$(date +'%Y%m%d')
      SHORT_SHA1=$(git rev-parse --short HEAD)
      export CHECTL_VERSION=0.0.$CURRENT_DAY-next
      export GITHUB_RELEASE_NAME=0.0.$CURRENT_DAY-next.$SHORT_SHA1
    fi;
    if [ "$TRAVIS_BRANCH" = release ]; then
      echo "Branch is release branch..."
      export CHECTL_VERSION=$(cat VERSION)
      export TRAVIS_TAG=${TRAVIS_TAG:-$CHECTL_VERSION}
      export GITHUB_RELEASE_NAME=$CHECTL_VERSION
    fi;
    sed -i sed "s#version\":\ \"\(.*\)\",#version\":\ \"$CHECTL_VERSION\",#g" package.json
    git tag $TRAVIS_TAG
    npx oclif-dev pack
    git clone https://github.com/che-incubator/chectl -b gh-pages --single-branch gh-pages
    rm -rf gh-pages/.git
    echo $(date +%s) > gh-pages/update
    env
  fi
deploy:
  - provider: releases
    api-key:
      secure: VF/xQoNU+pxVV9Sl1Dm7ivHeSUiUO1uzFdxEhH/nev1hUsZBqa2YGcXuRQ5MWX4BF8ltSG6W6eka3WU0Sma2oD9HXt7XfIbQEmeHjh9bR0D1O019wcMTvQwUXk7Lk823mLu2hzc3oXDgM2w0xmCsnffs2lDVP96jq9yk+x3m73EXaoVetOHJNGG+z4tVHql4NP4iyM3uBP2s6Xwrx6GgrcAuShzxa4HKacwjnTjIFiF9i2VYZITavKmCwW6CbeSDzIEtQ9778pwNk1woHfs0PmBwUkcGZ1xf+vA0f/HtZVlaPTmOJZPYoDQ3IrM83M+g3SCvG+TKSHf0iWcQURSdI+zTTshDuHV/WgyhsBiSq+xzoxZqDKgNeuH1NAw5qEyEmvV1AN/2Cl0El8iUSZUBGPU9oFd4uo0K7o1WkG0v0/zGJReRuyHzP8qxPpk7Ejli+RL05mQhHf8Xk4YuxMxVpdam+SdYyL+D+6yhoBKf2RClABVhVbDRAcUt9U+Q46eUrNYIY5zSkSzHOhvgGQ+ZgygdRMMrmNTFPgFsiKrCc3Uvv2iOe/fmpSNuDOWdedK9cAS1tmcXeGVGGCTE7qGoCXcsmhV/qaPNB0onSwZ/S+eqnFDiSNXctxxp04hYbZ8HZxrWEdI1FfRX2s1A1jazThhuXZ/l5HDiHFlbTHVV43g=
    file_glob: true
    name: $GITHUB_RELEASE_NAME
    file:
      - "./dist/channels/**/chectl-*.gz"
    skip_cleanup: true
    on:
      repo: flacatus/chectl
      tags: false
      all_branches: true
      condition: $TRAVIS_BRANCH =~ ^(master|release)$
  - provider: pages
    github-token:
      secure: VF/xQoNU+pxVV9Sl1Dm7ivHeSUiUO1uzFdxEhH/nev1hUsZBqa2YGcXuRQ5MWX4BF8ltSG6W6eka3WU0Sma2oD9HXt7XfIbQEmeHjh9bR0D1O019wcMTvQwUXk7Lk823mLu2hzc3oXDgM2w0xmCsnffs2lDVP96jq9yk+x3m73EXaoVetOHJNGG+z4tVHql4NP4iyM3uBP2s6Xwrx6GgrcAuShzxa4HKacwjnTjIFiF9i2VYZITavKmCwW6CbeSDzIEtQ9778pwNk1woHfs0PmBwUkcGZ1xf+vA0f/HtZVlaPTmOJZPYoDQ3IrM83M+g3SCvG+TKSHf0iWcQURSdI+zTTshDuHV/WgyhsBiSq+xzoxZqDKgNeuH1NAw5qEyEmvV1AN/2Cl0El8iUSZUBGPU9oFd4uo0K7o1WkG0v0/zGJReRuyHzP8qxPpk7Ejli+RL05mQhHf8Xk4YuxMxVpdam+SdYyL+D+6yhoBKf2RClABVhVbDRAcUt9U+Q46eUrNYIY5zSkSzHOhvgGQ+ZgygdRMMrmNTFPgFsiKrCc3Uvv2iOe/fmpSNuDOWdedK9cAS1tmcXeGVGGCTE7qGoCXcsmhV/qaPNB0onSwZ/S+eqnFDiSNXctxxp04hYbZ8HZxrWEdI1FfRX2s1A1jazThhuXZ/l5HDiHFlbTHVV43g=
    skip_cleanup: true
    keep_history: true
    local-dir: gh-pages
    on:
      repo: flacatus/chectl
      all_branches: true
      condition: $TRAVIS_BRANCH =~ ^(master|release)$
